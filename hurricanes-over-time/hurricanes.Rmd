---
title: "Have Hurricanes Gotten More Severe"
output:
  html_document: default
  html_notebook: default
  pdf_document: default
---

```{r, warning=FALSE}
source('db_conn.R')
source('hurricanes.R')
conn <- hurr_db_connect()

library(leaflet)
library(ggplot2)
library(pander)
# library(rjson) Trash
```

```{r ggplot Default Theme, echo=FALSE}
theme_set(theme_bw() + theme(
    legend.position="bottom",
    panel.border = element_blank(),
    panel.grid.major = element_blank(),
    panel.grid.minor = element_blank(),
    axis.line = element_line(colour = "black")))
```

# Hurricanes
## Measuring the intensity of hurricanes
### Saffir-Simpson Hurricane Scale

```{r "SSHS Diagram"}
sshs_diagram()
```

## Have hurricanes gotten more severe over the years
```{sql connection=conn, output.var='hurr_by_year'}
SELECT
  season, count(name), AVG(wind_max_kt), saffir_simpson(AVG(wind_max_kt))
FROM hurricane_summary
WHERE season > 1900 AND wind_max_kt::int != -999
GROUP BY season
ORDER BY season
```

```{sql connection=conn, output.var='hurr_by_year2'}
SELECT
  season, count(name), AVG(wind_max_kt), saffir_simpson(AVG(wind_max_kt))
FROM hurricane_summary
WHERE season > 1950 AND wind_max_kt::int != -999
GROUP BY season
ORDER BY season
```

```{r}
pander(hurr_by_year2)
```

```{r}
ggplot(hurr_by_year, aes(season, count)) +
  geom_bar(stat='identity') +
  labs(
    title="Number of Hurricanes per Season",
    x="Year",
    y="Number"
  )
```

## 1900 Galveston Hurricane
```{sql connection=conn, output.var='galv1900'}
WITH galv1900 AS (SELECT * FROM hurricane_summary
WHERE season::int = 1900
AND st_intersects(path, (SELECT geom FROM us_states WHERE name LIKE 'Texas')))
SELECT
    (jsonb_array_elements(st_asgeojson(path)::jsonb->'coordinates')->>0)::float AS lon,
    (jsonb_array_elements(st_asgeojson(path)::jsonb->'coordinates')->>1)::float AS lat
FROM galv1900
```

### Path
```{r}
# See: https://stackoverflow.com/questions/42989040/how-to-troubleshoot-missing-osm-tiles-in-leaflet-html-widget
m <- leaflet()
m <- addProviderTiles(m, providers$Esri.WorldImagery, group = "Esri")
for (i in 1:nrow(galv1900)) {
  m <- addCircleMarkers(m, lng=galv1900[i, 1], lat=galv1900[i, 2])
}
m
```

